<div class="card">

    <!-- Global Worker Productivity Control -->
    <div class="mb-4 p-3" style="background-color: #f8f9fa; border-radius: 6px;">
        <label for="workerProductivity" style="font-weight: bold; margin-right: 10px;">
            Worker Productivity:
        </label>
        <input
            id="workerProductivity"
            type="number"
            [(ngModel)]="workerProductivity"
            (blur)="onProductivityChange()"
            [min]="30"
            [max]="125"
            style="width: 80px; text-align: center; margin-right: 10px;">
        <span>% (affects all industries)</span>

        <label for="percentOfWorkers" style="font-weight: bold; margin-left: 20px; margin-right: 10px;">
            Percent of Workers:
        </label>
        <input
            id="percentOfWorkers"
            type="number"
            [(ngModel)]="percentOfWorkers"
            (blur)="onPercentOfWorkersChange()"
            [min]="0"
            [max]="100"
            style="width: 80px; text-align: center; margin-right: 10px;">
        <span>% (affects max workers available)</span>
    </div>

    <p-table [value]="industries" dataKey="name" [tableStyle]="{ 'min-width': '40rem' }" [expandedRowKeys]="expandedRows" (onRowExpand)="onRowExpand($event)" (onRowCollapse)="onRowCollapse($event)">
        <ng-template #caption>
            <div class="flex flex-wrap justify-end gap-2">
                <p-button label="Expand All" icon="pi pi-plus" text (onClick)="expandAll()" />
                <p-button label="Collapse All" icon="pi pi-minus" text (onClick)="collapseAll()" />
            </div>
        </ng-template>
        <ng-template #header>
            <tr>
                <th style="width: 5rem"></th>
                <th pSortableColumn="name">Industry Name <p-sortIcon field="name" /></th>
                <th pSortableColumn="currentWorkers">Current Workers <p-sortIcon field="currentWorkers" /></th>
                <th pSortableColumn="efficiency">Efficiency <p-sortIcon field="efficiency" /></th>
                <th pSortableColumn="ussrDailyCost">USSR Daily Cost (₽) <p-sortIcon field="ussrDailyCost" /></th>
                <th pSortableColumn="ussrDailyProfit">USSR Daily Profit (₽) <p-sortIcon field="ussrDailyProfit" /></th>
                <th pSortableColumn="ussrProfitPerWorker">USSR Profit/Worker (₽) <p-sortIcon field="ussrProfitPerWorker" /></th>
                <th pSortableColumn="natoDailyCost">NATO Daily Cost ($) <p-sortIcon field="natoDailyCost" /></th>
                <th pSortableColumn="natoDailyProfit">NATO Daily Profit ($) <p-sortIcon field="natoDailyProfit" /></th>
                <th pSortableColumn="natoProfitPerWorker">NATO Profit/Worker ($) <p-sortIcon field="natoProfitPerWorker" /></th>
            </tr>
        </ng-template>
        <ng-template #body let-industry let-expanded="expanded">
            <tr>
                <td>
                    <p-button type="button" pRipple [pRowToggler]="industry" [text]="true" severity="contrast" [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'" />
                </td>
                <td>{{ industry.name }}</td>
                <td>
                    <input type="number"
                           [ngModel]="getCurrentWorkers(industry.name)"
                           (blur)="onWorkerBlur(industry.name, $event)"
                           [min]="1"
                           [max]="getMaxWorkers(industry)"
                           style="width: 80px; text-align: center;">
                    <span style="margin-left: 5px; color: #666; font-size: 0.9em;">({{ getMaxWorkers(industry) }})</span>
                </td>
                <td>{{ getEfficiency(industry.name) | percent:'1.0-1' }}</td>
                <td style="color: red;">₽{{ calculateDailyCost(industry, 'USSR') | number:'1.2-2' }}</td>
                <td style="color: green;">₽{{ calculateDailyProfit(industry, 'USSR') | number:'1.2-2' }}</td>
                <td style="color: green;">₽{{ calculateProfitPerWorker(industry, 'USSR') | number:'1.2-2' }}</td>
                <td style="color: red;">{{ calculateDailyCost(industry, 'NATO') | currency:'USD':'symbol':'1.2-2' }}</td>
                <td style="color: green;">{{ calculateDailyProfit(industry, 'NATO') | currency:'USD':'symbol':'1.2-2' }}</td>
                <td style="color: green;">{{ calculateProfitPerWorker(industry, 'NATO') | currency:'USD':'symbol':'1.2-2' }}</td>
            </tr>
        </ng-template>
        <ng-template #expandedrow let-industry>
            <tr>
                <td colspan="10">
                    <div class="p-4">
                        <h4>Calculation Details for {{ industry.name }}</h4>

                        <!-- Unified Calculation Table -->
                        <div class="mb-4" style="overflow-x: auto;">
                            <p-table [value]="getCalculationBreakdown(industry)" [tableStyle]="{ 'min-width': '70rem', 'width': '100%' }">
                                <ng-template #header>
                                    <tr>
                                        <th style="text-align: left; width: 150px;">Type</th>
                                        <th style="text-align: left; width: 200px;">Resource/Product</th>
                                        <th style="text-align: left; width: 150px;">Source</th>
                                        <th style="text-align: right; width: 100px;">Quantity</th>
                                        <th style="text-align: right; width: 120px;">USSR Price (₽)</th>
                                        <th style="text-align: right; width: 120px;">USSR Total (₽)</th>
                                        <th style="text-align: right; width: 120px;">NATO Price ($)</th>
                                        <th style="text-align: right; width: 120px;">NATO Total ($)</th>
                                    </tr>
                                </ng-template>
                                <ng-template #body let-item>
                                    <tr [ngStyle]="{ 'background-color': item.backgroundColor }">
                                        <td style="text-align: left;"><strong>{{ item.type }}</strong></td>
                                        <td style="text-align: left;">{{ item.name }}</td>
                                        <td style="text-align: left;">
                                            <select
                                                [ngModel]="item.inputSource || 'USSR'"
                                                (ngModelChange)="setInputSource(item.industryName, item.resourceName, $event)"
                                                style="width: 100px; font-size: 12px;"
                                                [disabled]="item.type !== 'COST (Input)'">
                                                <option value="USSR">USSR</option>
                                                <option value="NATO">NATO</option>
                                                <option value="Own">Own Production</option>
                                            </select>
                                        </td>
                                        <td style="text-align: right;">{{ item.quantity | number:'1.2-2' }}</td>
                                        <td style="text-align: right;">{{ item.ussrPrice === '-' || typeof item.ussrPrice === 'string' ? item.ussrPrice : ('₽' + (item.ussrPrice | number:'1.2-2')) }}</td>
                                        <td style="text-align: right;">{{ item.ussrTotal === '-' ? item.ussrTotal : ('₽' + (item.ussrTotal | number:'1.2-2')) }}</td>
                                        <td style="text-align: right;">{{ item.natoPrice === '-' || typeof item.natoPrice === 'string' ? item.natoPrice : (item.natoPrice | currency:'USD':'symbol':'1.2-2') }}</td>
                                        <td style="text-align: right;">{{ item.natoTotal === '-' ? item.natoTotal : (item.natoTotal | currency:'USD':'symbol':'1.2-2') }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>

                        <!-- Construction Cost Table -->
                        <div class="mb-4" style="overflow-x: auto;">
                            <h4 style="color: orange;">Construction Cost Breakdown</h4>
                            <p-table [value]="getConstructionBreakdown(industry)" [tableStyle]="{ 'min-width': '50rem', 'width': '100%' }">
                                <ng-template #header>
                                    <tr>
                                        <th style="text-align: left; width: 200px;">Resource</th>
                                        <th style="text-align: left; width: 150px;">Source</th>
                                        <th style="text-align: right; width: 100px;">Quantity</th>
                                        <th style="text-align: right; width: 120px;">USSR Price (₽)</th>
                                        <th style="text-align: right; width: 120px;">USSR Total (₽)</th>
                                        <th style="text-align: right; width: 120px;">NATO Price ($)</th>
                                        <th style="text-align: right; width: 120px;">NATO Total ($)</th>
                                    </tr>
                                </ng-template>
                                <ng-template #body let-item>
                                    <tr [ngStyle]="{ 'background-color': item.backgroundColor }">
                                        <td style="text-align: left;">{{ item.name }}</td>
                                        <td style="text-align: left;">
                                            <select *ngIf="item.type !== 'TOTAL'"
                                                [ngModel]="item.inputSource || 'USSR'"
                                                (ngModelChange)="setConstructionSource(industry.name, item.resourceName, $event)"
                                                style="width: 100px; font-size: 12px;">
                                                <option value="USSR">USSR</option>
                                                <option value="NATO">NATO</option>
                                                <option value="Own">Own Production</option>
                                            </select>
                                            <span *ngIf="item.type === 'TOTAL'">-</span>
                                        </td>
                                        <td style="text-align: right;">{{ item.quantity | number:'1.2-2' }}</td>
                                        <td style="text-align: right;">{{ item.ussrPrice === '-' || typeof item.ussrPrice === 'string' ? item.ussrPrice : ('₽' + (item.ussrPrice | number:'1.2-2')) }}</td>
                                        <td style="text-align: right;">{{ item.ussrTotal === '-' ? item.ussrTotal : ('₽' + (item.ussrTotal | number:'1.2-2')) }}</td>
                                        <td style="text-align: right;">{{ item.natoPrice === '-' || typeof item.natoPrice === 'string' ? item.natoPrice : (item.natoPrice | currency:'USD':'symbol':'1.2-2') }}</td>
                                        <td style="text-align: right;">{{ item.natoTotal === '-' ? item.natoTotal : (item.natoTotal | currency:'USD':'symbol':'1.2-2') }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>

                        <!-- Time-based Profit Summary -->
                        <div class="mb-4">
                            <h4 style="color: purple;">Profit Over Time (theoretical currency values)</h4>
                            <p-table [value]="getTimeProfitSummary(industry)" [tableStyle]="{ 'min-width': '60rem' }">
                                <ng-template #header>
                                    <tr style="background-color: #f3e5f5;">
                                        <th>Time Period</th>
                                        <th>USSR Total Profit</th>
                                        <th>USSR Profit/Worker</th>
                                        <th>NATO Total Profit</th>
                                        <th>NATO Profit/Worker</th>
                                    </tr>
                                </ng-template>
                                <ng-template #body let-item>
                                    <tr>
                                        <td><strong>{{ item.period }}</strong></td>
                                        <td style="color: green;">₽{{ item.ussrProfit | number:'1.2-2' }}</td>
                                        <td style="color: green;">₽{{ item.ussrWorkerProfit | number:'1.2-2' }}</td>
                                        <td style="color: green;">{{ item.natoProfit | currency:'USD':'symbol':'1.2-2' }}</td>
                                        <td style="color: green;">{{ item.natoWorkerProfit | currency:'USD':'symbol':'1.2-2' }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>

                        <!-- ROI Analysis -->
                        <div class="mb-4">
                            <h4 style="color: #d63384;">Return on Investment Analysis (theoretical currency values)</h4>
                            <p-table [value]="getROISummary(industry)" [tableStyle]="{ 'min-width': '40rem' }">
                                <ng-template #header>
                                    <tr style="background-color: #fdf2f8;">
                                        <th>Metric</th>
                                        <th>USSR</th>
                                        <th>NATO</th>
                                    </tr>
                                </ng-template>
                                <ng-template #body let-item>
                                    <tr>
                                        <td><strong>{{ item.metric }}</strong></td>
                                        <td>
                                            <span *ngIf="item.unit === 'currency'" style="color: green;">
                                                ₽{{ item.ussrValue | number:'1.2-2' }}
                                            </span>
                                            <span *ngIf="item.unit === 'days'">
                                                {{ item.ussrValue === -1 ? 'Never (no profit)' : (item.ussrValue | number:'1.0-0') + ' days' }}
                                            </span>
                                            <span *ngIf="item.unit === 'percentage'" [style.color]="item.ussrValue > 0 ? 'green' : 'red'">
                                                {{ item.ussrValue | number:'1.2-2' }}%
                                            </span>
                                        </td>
                                        <td>
                                            <span *ngIf="item.unit === 'currency'" style="color: green;">
                                                ${{ item.natoValue | number:'1.2-2' }}
                                            </span>
                                            <span *ngIf="item.unit === 'days'">
                                                {{ item.natoValue === -1 ? 'Never (no profit)' : (item.natoValue | number:'1.0-0') + ' days' }}
                                            </span>
                                            <span *ngIf="item.unit === 'percentage'" [style.color]="item.natoValue > 0 ? 'green' : 'red'">
                                                {{ item.natoValue | number:'1.2-2' }}%
                                            </span>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>